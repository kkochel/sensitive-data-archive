# SDA Message broker

Source repository: [https://github.com/neicnordic/sensitive-data-archive](https://github.com/neicnordic/sensitive-data-archive)

## Installing the Chart

Edit the values.yaml file and specify the relevant parts of the `config` section.  

Parameter | Description | Default
--------- | ----------- | -------
`image.repository` | sda-mq container image repository | `ghcr.io/neicnordic/sensitive-data-archive`
`image.tag` | sda-mq  container image version | ``
`image.pullPolicy` | sda-mq container image pull policy | `Always`
`global.adminUser` | Username of admin user |`admin`
`global.adminPassword` | Password for admin user. |`Random if unset`
`global.ingress.annotations` | extra annotations for the ingress objects | `""`
`global.ingress.ingressClassName` | class of the ingress controller | `"nginx"`
`global.ingress.clusterIssuer` | If cert-manager is set up to request certificates to the ingress endpoints, the configured clusterIssuer can be specified to automate certificate configuration for the ingress endpoint. | `""`
`global.ingress.hostName` | hostname for the ingress endpoint | `""`
`global.ingress.issuer` | If cert-manager is set up to request certificates to the ingress endpoints, the configured issuer can be specified to automate certificate configuration for the ingress endpoint. | `""`
`global.ingress.secretName` | The name of a manually created secret holding the certificates for the ingress enpoint. | `""`
`global.tls.enabled` | Use TLS for all connections. |`true`
`global.tls.issuer` | Issuer for TLS certificate creation. |`""`
`global.tls.clusterIssuer` | ClusterIssuer for TLS certificate creation. |`""`
`global.tls.secretName` | Name of the secret that holds the certificates. |`""`
`global.tls.serverKey` | Name of the certificate private key file. |`""`
`global.tls.serverCert` | Name of the certificate file. |`""`
`global.tls.caCert` | Name of the CA file. |`""`
`global.tls.verifyPeer` | Require client certificates. |`true`
`global.vhost` | default vhost is 'sda' unless specifically named |`""`
`global.shovel.host` | Hostname of federated server |`""`
`global.shovel.pass` | Password to federated server |`""`
`global.shovel.port` | Port that federated server listens on |`5671`
`global.shovel.user` | Username to federated server |`""`
`global.shovel.vhost` | Vhost on federated sever to connect to |`""`
`externalPkiService.tlsPath` | If an external PKI service is used, this is the path where the certifiates are placed | `""`
`extraConfig.consumer_timeout` | message handling timeout in milliseconds | `""`
`rbacEnabled` | Use role based access control. |`true`
`revisionHistory` | Number of revisions to keep for the option to rollback a deployment | `3`
`updateStrategyType` | Update strategy type. | `RollingUpdate`
`networkPolicy.create` | Use network isolation. | `false`
`networkPolicy.matchLabels` | App labels that are allowed to connect to the Message broker. | `app: sda-svc`
`persistence.enabled` | Enable persistence. | `true`
`persistence.storageSize` | Volume size. | `8Gi`
`persistence.storageClass` | Use specific storage class, by default dynamic provisioning enabled. | `null`
`persistence.existingClaim` | Use existing claim. | `null`
`persistence.volumePermissions` | Change the owner of the persist volume mountpoint to `RunAsUser:fsGroup`. | `true`
`service.type` | Message broker service type. |`ClusterIP`
`service.port` | Message broker service port. |`5671`
`resources.requests.memory` | Memory request for container. |`1Gi`
`resources.requests.cpu` | CPU request for container. |`1`
`resources.limits.memory` | Memory limit for container. |`2Gi`
`resources.limits.cpu` | CPU limit for container. |`2`
`testimage.tls.secretName` | Name of the testers secret that holds the certificates. |`""`
`testimage.tls.serverKey` | Name of the testers certificate private key file. |`""`
`testimage.tls.serverCert` | Name of testers the certificate file. |`""`
`testimage.tls.caCert` | Name of the CA file. |`""`

### TLS

Automatic certificates can be generated by setting `global.tls.issuer` or `glbal.tls.clusterIssuer` if `cert-manger` is installed and configured.

If certificates are created manually the secret that holds them needs to be created manually.

```cmd
kubectl create secret generic ca-secret \
--from-file=ca.crt\
--from-file=tls.crt\
--from-file=tls.key
```

If helm tests are to be used the testers client certificates must be accessible as a secret.

```cmd
kubectl create secret generic tester-certs \
--from-file=ca.crt\
--from-file=tls.crt\
--from-file=tls.key
```
